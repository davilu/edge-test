ARG base_tag=1.0.6.2-linux-arm64v8
FROM azureiotedge/azureiotedge-module-base:${base_tag}

ARG EXE_DIR=.

ARG ARG_IOTHUB_HOST
ENV ENV_IOTHUB_HOST=$ARG_IOTHUB_HOST

ARG ARG_IOTHUB_OWNER_SHARED_ACCESS_KEY
ENV ENV_IOTHUB_OWNER_SHARED_ACCESS_KEY=$ARG_IOTHUB_OWNER_SHARED_ACCESS_KEY

ARG ARG_EDGEHUB_HOST
ENV ENV_EDGEHUB_HOST=$ARG_EDGEHUB_HOST

ARG ARG_EDGE_DEVICE_ID
ENV ENV_EDGE_DEVICE_ID=$ARG_EDGE_DEVICE_ID

ARG ARG_LEAF_DEVICE_ID_PREFIX
ENV ENV_LEAF_DEVICE_ID_PREFIX=$ARG_LEAF_DEVICE_ID_PREFIX

ARG ARG_USE_SDK
ENV ENV_USE_SDK=$ARG_USE_SDK

ARG ARG_PUBLISH_TOPICS
ENV ENV_PUBLISH_TOPICS=$ARG_PUBLISH_TOPICS

ARG ARG_SUBSCRIPTION_TOPICS
ENV ENV_SUBSCRIPTION_TOPICS=$ARG_SUBSCRIPTION_TOPICS

ARG ARG_USE_NATIVE_MQTT_CLIENT
ENV ENV_USE_NATIVE_MQTT_CLIENT=$ARG_USE_NATIVE_MQTT_CLIENT

ARG ARG_DEBUG_LOG_ON
ENV ENV_DEBUG_LOG_ON=$ARG_DEBUG_LOG_ON

ENV MODULE_NAME "DeviceApp.dll"

WORKDIR /app

COPY $EXE_DIR/ ./

USER moduleuser

CMD echo "$(date --utc +"%Y-%m-%d %H:%M:%S %:z") Starting Module" && \
    exec /usr/bin/dotnet DeviceApp.dll
